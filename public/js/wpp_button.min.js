if (typeof jQuery == 'undefined') {
	function getScript(url, success) {
		var script     = document.createElement('script');
		script.src = url;
		var head = document.getElementsByTagName('head')[0],
		done = false;
		// Attach handlers for all browsers
		script.onload = script.onreadystatechange = function() {
			if (!done && (!this.readyState || this.readyState == 'loaded' || this.readyState == 'complete')) {
			done = true;
				// callback function provided as param
				success();
				script.onload = script.onreadystatechange = null;
				head.removeChild(script);
			};
		};
		head.appendChild(script);
	};
	getScript('https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js', function() {
        main();
    });
    
} else { // jQuery was already loaded
	main();
};


var displayForm = false;
var closedFormIframe = {
	width : 80,
	height: 80,
	displayForm: false
};
var openFormIframe = {
	width : 500,
    height : 400,
    displayForm : true
};

function main() {
	
	setTimeout(function() {
		let searchParams = new URLSearchParams(window.location.search);
		datacrm_whatsapp_config.campaign_gclid = searchParams.get('gclid');
		var params = new URLSearchParams(datacrm_whatsapp_config).toString();
        var identificatorUrl = 'https://integraciones.datacrm.la/datacrm/whatsapp_button/index.html?' + params;
        var iframe = '<iframe id="wpp-iframe" src="' + identificatorUrl + '" style="-moz-user-select: none; -webkit-user-select: none; -ms-user-select: none; user-select: none; width: 80px; z-index: 999999; height: 80px; bottom: 0px; right: 10px; position: fixed; " frameborder="0" sandbox="allow-forms allow-scripts allow-same-origin allow-top-navigation-by-user-activation"></iframe>'
        jQuery("body").append(iframe);
	}, 600);

	window.addEventListener('message', function (e) {
		if (e.data.hasOwnProperty('displayForm')) {
			displayForm = e.data.displayForm;
			var iframeSize = (e.data.displayForm) ? openFormIframe : closedFormIframe;
			var mqLarge  = window.matchMedia('(max-width: 500px)');
			if(mqLarge.matches && iframeSize.width != 80) {
				jQuery("#wpp-iframe").css({"width": "100%", "height":"450px"});
			}else{
				jQuery("#wpp-iframe").css({"width": iframeSize.width + "px", "height": iframeSize.height + "px"});
			}
		}
		if (e.data.hasOwnProperty('redirectUrl')) {
			window.open(e.data.redirectUrl, '_blank');
		}
	});

	jQuery(window).on('resize', function(){
		if (!displayForm) return;
		var win = jQuery(this);
		if (win.width() <= 500) { 
			jQuery("#wpp-iframe").css({"width": "100%", "height":"450px"});
		}else{
			jQuery("#wpp-iframe").css({"width": openFormIframe.width + "px","height": openFormIframe.height+"px"});
		}
	});

}
